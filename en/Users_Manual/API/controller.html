<!DOCTYPE HTML>
<html lang="en" class="navy sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Controller - AUTD3 Developers Manual v36.0.2</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../css/codeblock_filename.css">
        <link rel="stylesheet" href="../../css/lightbox.css">
        <link rel="stylesheet" href="../../css/open-in.css">
        <link rel="stylesheet" href="../../css/no-link-summary.css">
        <link rel="stylesheet" href="../../css/tab.css">
        <link rel="stylesheet" href="../../css/faq.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">AUTD3 Developers Manual v36.0.2</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shinolab/autd3-doc" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="controller"><a class="header" href="#controller">Controller</a></h1>
<p>This section introduces the APIs available in the <code>Controller</code>.</p>
<ul>
<li><a href="#fpga_state">fpga_state</a></li>
<li><a href="#send">send</a></li>
<li><a href="#sender">sender</a>
<ul>
<li><a href="#about-ack-check">About ack check</a></li>
<li><a href="#about-parallel-computation">About Parallel Computation</a></li>
</ul>
</li>
<li><a href="#inspect-available-only-in-rust"><code>inspect</code> (available only in Rust)</a></li>
</ul>
<h2 id="fpga_state"><a class="header" href="#fpga_state">fpga_state</a></h2>
<p>Retrieve the state of the FPGA.
Before using this, you need to enable state retrieval with <code>ReadsFPGAState</code>.</p>
<div class="mdbook-inpage-tabs"><input id="Rust-tab-0" type="radio" class="mdbook-inpage-tab" name="tab-0" checked>
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="Rust-tab-0">Rust</label><input id="C++-tab-0" type="radio" class="mdbook-inpage-tab" name="tab-0">
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="C++-tab-0">C++</label><input id="C#-tab-0" type="radio" class="mdbook-inpage-tab" name="tab-0">
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="C#-tab-0">C#</label><input id="Python-tab-0" type="radio" class="mdbook-inpage-tab" name="tab-0">
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="Python-tab-0">Python</label><div class="mdbook-inpage-tab-content" id=Rust-content>
<pre><code class="language-rust edition2024"><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::open([AUTD3::default()], autd3::link::Nop::new())?;
</span>autd.send(ReadsFPGAState::new(|_dev| true))?;

let info = autd.fpga_state()?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
</div><div class="mdbook-inpage-tab-content" id=C++-content>
<pre><code class="language-cpp"><span class="boring">#include&lt;autd3.hpp&gt;
</span><span class="boring">#include&lt;autd3/link/nop.hpp&gt;
</span><span class="boring">int main() {
</span><span class="boring">using namespace autd3;
</span><span class="boring">auto autd =
</span><span class="boring">Controller::open({AUTD3{}}, link::Nop{});
</span>autd.send(ReadsFPGAState([](const auto&amp;) { return true; }));

const auto info = autd.fpga_state();
<span class="boring">return 0; }
</span></code></pre>
</div><div class="mdbook-inpage-tab-content" id=C#-content>
<pre><code class="language-cs"><span class="boring">using AUTD3Sharp;
</span><span class="boring">using AUTD3Sharp.Link;
</span><span class="boring">using AUTD3Sharp.Utils;
</span><span class="boring">using var autd = Controller.Open([new AUTD3()], new Nop());
</span>autd.Send(new ReadsFPGAState(_ =&gt; true));

var info = autd.FPGAState();
</code></pre>
</div><div class="mdbook-inpage-tab-content" id=Python-content>
<pre><code class="language-python"><span class="boring">from pyautd3 import Controller, AUTD3, ReadsFPGAState
</span><span class="boring">from pyautd3.link.nop import Nop
</span><span class="boring">autd = Controller.open([AUTD3()], Nop())
</span>autd.send(ReadsFPGAState(lambda _: True))

info = autd.fpga_state()
</code></pre>
</div></div>
<p>The argument of the <code>ReadsFPGAState</code> constructor is <code>Fn(&amp;Device) -&gt; bool</code>, which specifies whether to enable state retrieval for each device.</p>
<p><code>fpga_state</code> returns <code>None</code> for devices that are not enabled.</p>
<p>The following information can currently be obtained as the state of the FPGA:</p>
<ul>
<li><code>is_thermal_assert</code>: Whether the temperature sensor for fan control is asserted</li>
<li><code>current_mod_segment</code>: Current Modulation Segment</li>
<li><code>current_stm_segment</code>: Current FociSTM/GainSTM Segment</li>
<li><code>current_gain_segment</code>: Current Gain Segment</li>
<li><code>is_gain_mode</code>: Whether Gain is currently being used</li>
<li><code>is_stm_mode</code>: Whether FociSTM/GainSTM is currently being used</li>
</ul>
<h2 id="send"><a class="header" href="#send">send</a></h2>
<p>Send data to the device.</p>
<p>Data can be sent either individually or two at a time.</p>
<h2 id="sender"><a class="header" href="#sender">sender</a></h2>
<p>You can specify settings for sending via <code>sender</code>.</p>
<div class="mdbook-inpage-tabs"><input id="Rust-tab-1" type="radio" class="mdbook-inpage-tab" name="tab-1" checked>
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="Rust-tab-1">Rust</label><input id="C++-tab-1" type="radio" class="mdbook-inpage-tab" name="tab-1">
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="C++-tab-1">C++</label><input id="C#-tab-1" type="radio" class="mdbook-inpage-tab" name="tab-1">
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="C#-tab-1">C#</label><input id="Python-tab-1" type="radio" class="mdbook-inpage-tab" name="tab-1">
                                <label class="mdbook-inpage-tab-item" num-tabs=4 for="Python-tab-1">Python</label><div class="mdbook-inpage-tab-content" id=Rust-content>
<pre><code class="language-rust edition2024"><span class="boring">use autd3::prelude::*;
</span><span class="boring">use std::time::Duration;
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let mut autd = Controller::open([AUTD3::default()], autd3::link::Nop::new())?;
</span>let mut sender = autd.sender(
    SenderOption {
        send_interval: Duration::from_millis(1),
        receive_interval: Duration::from_millis(1),
        timeout: None,
        parallel: ParallelMode::Auto,
        strict: true
    },
    FixedSchedule::default(),
);
<span class="boring">let d = Null {};
</span>sender.send(d)?;
<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
</div><div class="mdbook-inpage-tab-content" id=C++-content>
<pre><code class="language-cpp"><span class="boring">#include&lt;chrono&gt;
</span><span class="boring">#include&lt;autd3.hpp&gt;
</span><span class="boring">#include&lt;autd3/link/nop.hpp&gt;
</span><span class="boring">int main() {
</span><span class="boring">using namespace autd3;
</span><span class="boring">auto autd = Controller::open({AUTD3{}}, link::Nop{});
</span>auto sender =
    autd.sender(SenderOption{.send_interval = std::chrono::milliseconds(1),
                             .receive_interval = std::chrono::milliseconds(1),
                             .timeout = std::nullopt,
                             .parallel = ParallelMode::Auto,
                             .strict = true},
                FixedSchedule{});
<span class="boring">const Null d;
</span>sender.send(d);
<span class="boring">return 0; }
</span></code></pre>
</div><div class="mdbook-inpage-tab-content" id=C#-content>
<pre><code class="language-cs"><span class="boring">using AUTD3Sharp;
</span><span class="boring">using AUTD3Sharp.Link;
</span><span class="boring">using AUTD3Sharp.Gain;
</span><span class="boring">using AUTD3Sharp.Utils;
</span><span class="boring">using var autd = Controller.Open([new AUTD3()], new Nop());
</span>var sender = autd.Sender(
    new SenderOption
    {
        SendInterval = Duration.FromMillis(1),
        ReceiveInterval = Duration.FromMillis(1),
        Timeout = null,
        Parallel = ParallelMode.Auto,
        Strict = true,
    },
    new FixedSchedule()
);
<span class="boring">var d = new Null();
</span>sender.Send(d);
</code></pre>
</div><div class="mdbook-inpage-tab-content" id=Python-content>
<pre><code class="language-python"><span class="boring">from pyautd3 import AUTD3, Controller, Duration, Null, SenderOption, FixedSchedule, ParallelMode
</span><span class="boring">from pyautd3.link.nop import Nop
</span><span class="boring">autd = Controller.open([AUTD3()], Nop())
</span>sender = autd.sender(
    SenderOption(
        send_interval=Duration.from_millis(1),
        receive_interval=Duration.from_millis(1),
        timeout=None,
        parallel=ParallelMode.Auto,
        strict=True
    ),
    FixedSchedule(),
)
<span class="boring">d = Null()
</span>sender.send(d)
</code></pre>
</div></div>
<p>Here,</p>
<ul>
<li><code>send_interval</code>: Send interval</li>
<li><code>receive_interval</code>: Receive interval</li>
<li><code>timeout</code>: Timeout duration. See <a href="#about-ack-check">About Ack check</a> for details.</li>
<li><code>parallel</code>: Parallel computation mode. See <a href="#about-parallel-computation">About Parallel Computation</a> for details.</li>
<li><code>strict</code>: Whether to strictly check the data to be sent. See <a href="#about-ack-check">About Ack check</a> for details.</li>
</ul>
<p>and the default values are as above.</p>
<p>The second argument is a structure to adjust send/receive intervals, and you can choose from the following:</p>
<ul>
<li><code>FixedSchedule</code>: Starts the next send at the specified interval from the start time of the previous send, regardless of the time taken for the send process.</li>
<li><code>FixedDelay</code>: Starts the next send after the specified interval from the completion of the send process.</li>
</ul>
<p>これらの構造体は, どのようにスレッドをスリープさせるかを指定する以下の構造体を持つ.
These structures have the following structures that specify how to put the thread to sleep:</p>
<ul>
<li><code>SpinSleeper</code>: Uses <a href="https://crates.io/crates/spin_sleep"><code>spin_sleep</code></a></li>
<li><code>StdSleeper</code>: Uses <a href="https://doc.rust-lang.org/std/thread/fn.sleep.html"><code>std::thread::sleep</code></a></li>
<li><code>SpinWait</code>: Uses busy-waiting</li>
</ul>
<p>Note that <code>Controller::send</code> and <code>Controller::group_send</code> are equivalent to <code>Sender::send</code> and <code>Sender::group_send</code> with the <code>Controller::default_sender_option</code> (which is configurable) and default <code>SpinSleeper</code>.</p>
<h3 id="about-ack-check"><a class="header" href="#about-ack-check">About ack check</a></h3>
<p>If the timeout value is</p>
<ul>
<li>greater than 0, the <code>send</code> function waits until the sent data is processed by the device or the specified timeout duration elapses. If it cannot confirm that the sent data was processed by the device, it returns an error.</li>
<li>0, the <code>send</code> function does not check whether the sent data was processed by the device.</li>
</ul>
<p>If you want to ensure that the data is sent, it is recommended to set this to an appropriate value.</p>
<p>If timeout is not specified in <code>SenderOption</code>, the default value (<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">200</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">ms</span></span></span></span></span></span>) is used.</p>
<p>When sending multiple data at once, the maximum timeout value of each data is used.</p>
<h3 id="about-parallel-computation"><a class="header" href="#about-parallel-computation">About Parallel Computation</a></h3>
<p>Internal calculations for each data can be executed in parallel on a per-device basis.</p>
<p>Specifying <code>ParallelMode::On</code> enables parallel computation, and <code>ParallelMode::Off</code> disables it.</p>
<p>In the case of <code>ParallelMode::Auto</code>, parallel computation is enabled if the number of devices exceeds the parallel computation threshold value for each data as shown below.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>Parallel Computation Threshold Value</th></tr></thead><tbody>
<tr><td><code>Clear</code>/<code>GPIOOutputs</code>/<br><code>ForceFan</code>/<code>PhaseCorrection</code>/<br><code>ReadsFPGAState</code>/<code>SwapSegment</code>/<br><code>Silencer</code>/<code>Synchronize</code>/<br><code>FociSTM</code> (less than 4000 foci)/<br><code>Modulation</code></td><td>18446744073709551615</td></tr>
<tr><td><code>PulseWidthEncoder</code>/<br><code>FociSTM</code> (4000 foci or more)/<br>/<code>GainSTM</code>/<code>Gain</code></td><td>4</td></tr>
</tbody></table>
</div>
<h2 id="inspect-available-only-in-rust"><a class="header" href="#inspect-available-only-in-rust"><code>inspect</code> (available only in Rust)</a></h2>
<p>The calculations for <code>Gain</code>, <code>Modulation</code>, <code>GainSTM</code>, and <code>FociSTM</code> are lazy for parallelization and to minimize memory allocation, and the calculation results are constructed directly within the frame.
Therefore, it is not possible to directly check these calculation results before sending.</p>
<p>By using <code>Controller::inspect</code>, you can check these calculation results without sending.</p>
<div class="mdbook-inpage-tabs"><input id="Rust-tab-2" type="radio" class="mdbook-inpage-tab" name="tab-2" checked>
                                <label class="mdbook-inpage-tab-item" num-tabs=1 for="Rust-tab-2">Rust</label><div class="mdbook-inpage-tab-content" id=Rust-content>
<pre><code class="language-rust edition2024"><span class="boring">use autd3::prelude::*;
</span><span class="boring">#[allow(unused_variables)]
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {
</span><span class="boring">let autd = Controller::open([AUTD3::default()], autd3::link::Nop::new())?;
</span>let r = autd.inspect(Null {})?;
dbg!(&amp;r[0]); // result of device 0
// &amp;r[0] = Some(
//     GainInspectionResult {
//         name: "Null",
//         data: [
//             Drive {
//                 phase: 0x00,
//                 intensity: 0x00,
//             },
//             ︙
//             Drive {
//                 phase: 0x00,
//                 intensity: 0x00,
//             },
//         ],
//         segment: S0,
//         transition_mode: None,
//     },
// )

<span class="boring">Ok(())
</span><span class="boring">}</span></code></pre>
</div></div>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/shinolab/autd3-doc/edit/main/src/en/Users_Manual/API/controller.md">Edit this page on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../Users_Manual/API/link/soem.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../Users_Manual/API/gain.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../Users_Manual/API/link/soem.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../Users_Manual/API/gain.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../js/codeblock_filename.js"></script>
        <script src="../../js/lightbox-plus-jquery.min.js"></script>


    </div>
    </body>
</html>
