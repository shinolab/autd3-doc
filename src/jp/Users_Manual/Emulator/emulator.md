# エミュレータ

`Emulator`を使用すると, `Simulator`よりも詳細な出力位相/パルス幅, 出力電圧, 出力音波, および, 音場の計算が行える.

> NOTE: 現在, `Emulator`はRust, 及び, Pythonからのみ使用可能である.
> C++, C#へ移植する予定はない.

`Emulator`が出力するデータはPolarsのDataFrameである.
詳しくは, [Polarsのドキュメント](https://pola.rs/)を参照されたい.

## 出力位相/パルス幅の計算

```rust,edition2021
{{#include ../../../codes/Users_Manual/emulator/emulator_drive.rs}}
```

```python
{{#include ../../../codes/Users_Manual/emulator/emulator_drive.py}}
```

> NOTE: `tick`で指定する時間間隔は, $\SI{25}{us}$の倍数である必要がある.

各時刻 ($\SI{25}{us}$単位) における, 位相/パルス幅が各列に格納される.
各列の名前は`<phase/pulsewidth>_<device_idx>_<transducer_idx>`である.

```
┌──────────┬───────────┬────────────────┬───────────┬───┬─────────────┬──────────────────┬─────────────┬──────────────────┐
│ time[s]  ┆ phase_0_0 ┆ pulsewidth_0_0 ┆ phase_0_1 ┆ … ┆ phase_0_247 ┆ pulsewidth_0_247 ┆ phase_0_248 ┆ pulsewidth_0_248 │
│ ---      ┆ ---       ┆ ---            ┆ ---       ┆   ┆ ---         ┆ ---              ┆ ---         ┆ ---              │
│ f32      ┆ u8        ┆ u8             ┆ u8        ┆   ┆ u8          ┆ u8               ┆ u8          ┆ u8               │
╞══════════╪═══════════╪════════════════╪═══════════╪═══╪═════════════╪══════════════════╪═════════════╪══════════════════╡
│ 0.0      ┆ 0         ┆ 4              ┆ 0         ┆ … ┆ 0           ┆ 4                ┆ 0           ┆ 4                │
│ 0.000025 ┆ 0         ┆ 8              ┆ 0         ┆ … ┆ 0           ┆ 8                ┆ 0           ┆ 8                │
│ 0.00005  ┆ 0         ┆ 12             ┆ 0         ┆ … ┆ 0           ┆ 12               ┆ 0           ┆ 12               │
│ 0.000075 ┆ 0         ┆ 16             ┆ 0         ┆ … ┆ 0           ┆ 16               ┆ 0           ┆ 16               │
│ 0.0001   ┆ 0         ┆ 21             ┆ 0         ┆ … ┆ 0           ┆ 21               ┆ 0           ┆ 21               │
│ …        ┆ …         ┆ …              ┆ …         ┆ … ┆ …           ┆ …                ┆ …           ┆ …                │
│ 0.009875 ┆ 0         ┆ 24             ┆ 0         ┆ … ┆ 0           ┆ 24               ┆ 0           ┆ 24               │
│ 0.0099   ┆ 0         ┆ 25             ┆ 0         ┆ … ┆ 0           ┆ 25               ┆ 0           ┆ 25               │
│ 0.009925 ┆ 0         ┆ 26             ┆ 0         ┆ … ┆ 0           ┆ 26               ┆ 0           ┆ 26               │
│ 0.00995  ┆ 0         ┆ 27             ┆ 0         ┆ … ┆ 0           ┆ 27               ┆ 0           ┆ 27               │
│ 0.009975 ┆ 0         ┆ 29             ┆ 0         ┆ … ┆ 0           ┆ 29               ┆ 0           ┆ 29               │
└──────────┴───────────┴────────────────┴───────────┴───┴─────────────┴──────────────────┴─────────────┴──────────────────┘
```

## 出力電圧

```rust,edition2021
{{#include ../../../codes/Users_Manual/emulator/emulator_voltage.rs}}
```

```python
{{#include ../../../codes/Users_Manual/emulator/emulator_voltage.py}}
```

各時刻 ($\SI{25}{us}/256$単位) における, 出力電圧が各列に格納される.
各列の名前は`voltage_<device_idx>_<transducer_idx>[V]`である.

```
┌───────────┬────────────────┬────────────────┬────────────────┬───┬──────────────────┬──────────────────┬──────────────────┬──────────────────┐
│ time[s]   ┆ voltage_0_0[V] ┆ voltage_0_1[V] ┆ voltage_0_2[V] ┆ … ┆ voltage_0_245[V] ┆ voltage_0_246[V] ┆ voltage_0_247[V] ┆ voltage_0_248[V] │
│ ---       ┆ ---            ┆ ---            ┆ ---            ┆   ┆ ---              ┆ ---              ┆ ---              ┆ ---              │
│ f32       ┆ f32            ┆ f32            ┆ f32            ┆   ┆ f32              ┆ f32              ┆ f32              ┆ f32              │
╞═══════════╪════════════════╪════════════════╪════════════════╪═══╪══════════════════╪══════════════════╪══════════════════╪══════════════════╡
│ 0.0       ┆ 12.0           ┆ 12.0           ┆ 12.0           ┆ … ┆ 12.0             ┆ 12.0             ┆ 12.0             ┆ 12.0             │
│ 9.7656e-8 ┆ 12.0           ┆ 12.0           ┆ 12.0           ┆ … ┆ 12.0             ┆ 12.0             ┆ 12.0             ┆ 12.0             │
│ 1.9531e-7 ┆ 12.0           ┆ 12.0           ┆ 12.0           ┆ … ┆ 12.0             ┆ 12.0             ┆ 12.0             ┆ 12.0             │
│ 2.9297e-7 ┆ 12.0           ┆ 12.0           ┆ 12.0           ┆ … ┆ 12.0             ┆ 12.0             ┆ 12.0             ┆ 12.0             │
│ 3.9062e-7 ┆ 12.0           ┆ 12.0           ┆ 12.0           ┆ … ┆ 12.0             ┆ 12.0             ┆ 12.0             ┆ 12.0             │
│ …         ┆ …              ┆ …              ┆ …              ┆ … ┆ …                ┆ …                ┆ …                ┆ …                │
│ 0.001     ┆ -12.0          ┆ -12.0          ┆ -12.0          ┆ … ┆ -12.0            ┆ -12.0            ┆ -12.0            ┆ -12.0            │
│ 0.001     ┆ -12.0          ┆ -12.0          ┆ -12.0          ┆ … ┆ -12.0            ┆ -12.0            ┆ -12.0            ┆ -12.0            │
│ 0.001     ┆ -12.0          ┆ -12.0          ┆ -12.0          ┆ … ┆ -12.0            ┆ -12.0            ┆ -12.0            ┆ -12.0            │
│ 0.001     ┆ -12.0          ┆ -12.0          ┆ -12.0          ┆ … ┆ -12.0            ┆ -12.0            ┆ -12.0            ┆ -12.0            │
│ 0.001     ┆ -12.0          ┆ -12.0          ┆ -12.0          ┆ … ┆ -12.0            ┆ -12.0            ┆ -12.0            ┆ -12.0            │
└───────────┴────────────────┴────────────────┴────────────────┴───┴──────────────────┴──────────────────┴──────────────────┴──────────────────┘
```

> NOTE: 表示の問題で, 時刻`0.001`が重複しているが, 内部的にはきちんと時間が進んでいる. 

## 出力音圧

```rust,edition2021
{{#include ../../../codes/Users_Manual/emulator/emulator_ultrasound.rs}}
```

```python
{{#include ../../../codes/Users_Manual/emulator/emulator_ultrasound.py}}
```

各時刻 ($\SI{25}{us}/256$単位) における, 規格化された出力音圧が各列に格納される.
各列の名前は`p_<device_idx>_<transducer_idx>[a.u.]`である.

```
┌───────────┬─────────────┬─────────────┬─────────────┬───┬───────────────┬───────────────┬───────────────┬───────────────┐
│ time[s]   ┆ p_0_0[a.u.] ┆ p_0_1[a.u.] ┆ p_0_2[a.u.] ┆ … ┆ p_0_245[a.u.] ┆ p_0_246[a.u.] ┆ p_0_247[a.u.] ┆ p_0_248[a.u.] │
│ ---       ┆ ---         ┆ ---         ┆ ---         ┆   ┆ ---           ┆ ---           ┆ ---           ┆ ---           │
│ f32       ┆ f32         ┆ f32         ┆ f32         ┆   ┆ f32           ┆ f32           ┆ f32           ┆ f32           │
╞═══════════╪═════════════╪═════════════╪═════════════╪═══╪═══════════════╪═══════════════╪═══════════════╪═══════════════╡
│ 0.0       ┆ 0.0         ┆ 0.0         ┆ 0.0         ┆ … ┆ 0.0           ┆ 0.0           ┆ 0.0           ┆ 0.0           │
│ 9.7656e-8 ┆ -0.000527   ┆ -0.000527   ┆ -0.000527   ┆ … ┆ -0.000527     ┆ -0.000527     ┆ -0.000527     ┆ -0.000527     │
│ 1.9531e-7 ┆ -0.000817   ┆ -0.000817   ┆ -0.000817   ┆ … ┆ -0.000817     ┆ -0.000817     ┆ -0.000817     ┆ -0.000817     │
│ 2.9297e-7 ┆ -0.000865   ┆ -0.000865   ┆ -0.000865   ┆ … ┆ -0.000865     ┆ -0.000865     ┆ -0.000865     ┆ -0.000865     │
│ 3.9062e-7 ┆ -0.000721   ┆ -0.000721   ┆ -0.000721   ┆ … ┆ -0.000721     ┆ -0.000721     ┆ -0.000721     ┆ -0.000721     │
│ …         ┆ …           ┆ …           ┆ …           ┆ … ┆ …             ┆ …             ┆ …             ┆ …             │
│ 0.001     ┆ -0.433034   ┆ -0.433034   ┆ -0.433034   ┆ … ┆ -0.433034     ┆ -0.433034     ┆ -0.433034     ┆ -0.433034     │
│ 0.001     ┆ -0.411363   ┆ -0.411363   ┆ -0.411363   ┆ … ┆ -0.411363     ┆ -0.411363     ┆ -0.411363     ┆ -0.411363     │
│ 0.001     ┆ -0.389469   ┆ -0.389469   ┆ -0.389469   ┆ … ┆ -0.389469     ┆ -0.389469     ┆ -0.389469     ┆ -0.389469     │
│ 0.001     ┆ -0.367366   ┆ -0.367366   ┆ -0.367366   ┆ … ┆ -0.367366     ┆ -0.367366     ┆ -0.367366     ┆ -0.367366     │
│ 0.001     ┆ -0.345066   ┆ -0.345066   ┆ -0.345066   ┆ … ┆ -0.345066     ┆ -0.345066     ┆ -0.345066     ┆ -0.345066     │
└───────────┴─────────────┴─────────────┴─────────────┴───┴───────────────┴───────────────┴───────────────┴───────────────┘
```

## 音場の計算

```rust,edition2021
{{#include ../../../codes/Users_Manual/emulator/emulator_field.rs}}
```

> NOTE: `gpu`オプションは, `gpu` featureを有効にしている場合のみ使用可能である.

```python
{{#include ../../../codes/Users_Manual/emulator/emulator_field.py}}
```

`print_progress`オプションを有効にすると計算の進捗が表示される.
また, `gpu`オプションを有効にすると, 計算がGPU上で実行される.

膨大なメモリが消費される可能性があるため, `next`関数によって, 一部時刻のみを取得するようになっている.
なお, `skip`関数を使用することで, 指定した時間だけスキップすることができる.

各観測点における, 出力音圧が時系列順 (単位は`time_step`で指定) に各列に格納される.
各列の名前は, 最初の3列は`<x/y/z>[mm]`, 以降は, `p[Pa]@<時刻>`である.

```
┌────────────┬───────────┬───────┬──────────────┬───┬────────────────┬────────────────┬────────────────────┬────────────────────┐
│ x[mm]      ┆ y[mm]     ┆ z[mm] ┆ p[Pa]@0.0005 ┆ … ┆ p[Pa]@0.000996 ┆ p[Pa]@0.000997 ┆ p[Pa]@0.0009979999 ┆ p[Pa]@0.0009989999 │
│ ---        ┆ ---       ┆ ---   ┆ ---          ┆   ┆ ---            ┆ ---            ┆ ---                ┆ ---                │
│ f32        ┆ f32       ┆ f32   ┆ f32          ┆   ┆ f32            ┆ f32            ┆ f32                ┆ f32                │
╞════════════╪═══════════╪═══════╪══════════════╪═══╪════════════════╪════════════════╪════════════════════╪════════════════════╡
│ 66.625267  ┆ 46.713196 ┆ 150.0 ┆ 22.33119     ┆ … ┆ 167.866791     ┆ 144.102798     ┆ 115.74894          ┆ 79.722481          │
│ 67.625267  ┆ 46.713196 ┆ 150.0 ┆ 23.059235    ┆ … ┆ 129.20607      ┆ 102.936798     ┆ 73.770485          ┆ 40.198856          │
│ 68.625267  ┆ 46.713196 ┆ 150.0 ┆ 23.035612    ┆ … ┆ 72.646194      ┆ 50.596352      ┆ 26.14632           ┆ -0.762609          │
│ 69.625267  ┆ 46.713196 ┆ 150.0 ┆ 21.585335    ┆ … ┆ 6.966023       ┆ -7.786146      ┆ -21.838703         ┆ -34.394341         │
│ 70.625267  ┆ 46.713196 ┆ 150.0 ┆ 17.394657    ┆ … ┆ -61.409634     ┆ -64.005798     ┆ -62.779099         ┆ -57.107864         │
│ …          ┆ …         ┆ …     ┆ …            ┆ … ┆ …              ┆ …              ┆ …                  ┆ …                  │
│ 102.625267 ┆ 86.713196 ┆ 150.0 ┆ 14.815326    ┆ … ┆ -72.807503     ┆ -84.871536     ┆ -92.016724         ┆ -93.664955         │
│ 103.625267 ┆ 86.713196 ┆ 150.0 ┆ 17.507444    ┆ … ┆ -27.580931     ┆ -60.442291     ┆ -89.672234         ┆ -113.374344        │
│ 104.625267 ┆ 86.713196 ┆ 150.0 ┆ 18.189449    ┆ … ┆ 20.942373      ┆ -27.426428     ┆ -72.527504         ┆ -114.272285        │
│ 105.625267 ┆ 86.713196 ┆ 150.0 ┆ 18.885788    ┆ … ┆ 67.135262      ┆ 10.796355      ┆ -47.196766         ┆ -97.698463         │
│ 106.625267 ┆ 86.713196 ┆ 150.0 ┆ 16.812973    ┆ … ┆ 103.391533     ┆ 45.7672        ┆ -15.155255         ┆ -69.365089         │
└────────────┴───────────┴───────┴──────────────┴───┴────────────────┴────────────────┴────────────────────┴────────────────────┘
```

さらなる, Exampleは[autd3-emulator (Rust)](https://github.com/shinolab/autd3-emulator/tree/main/examples), 及び, [pyautd3 (Python)](https://github.com/shinolab/pyautd3/tree/main/example/emulator)を参照されたい.
